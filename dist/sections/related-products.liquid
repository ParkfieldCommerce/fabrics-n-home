<div class="related-products" itemscope itemtype="http://schema.org/Product" id="ProductSection-{{ section.id }}" data-section-id="{{ section.id }}" data-section-type="product" data-enable-history-state="true">

	{% assign number_of_related_products_per_row = section.settings.related_grid_num %}
	{% assign number_of_rows = section.settings.related_grid_row %}
	{% assign heading = section.settings.related_title %}
	{% assign same_vendor = false %}
	{% assign same_type = false %}
	{% assign exclusions = 'frontpage,all' | split: ',' %}

	{% if product.metafields.c_f['Related Products'] %}
  	{% assign collection = collections[product.metafields.c_f['Related Products']] %}
	{% endif %}

	{% assign found_a_collection = false %}
	{% if collection and collection.all_products_count > 1 %}
	  {% unless exclusions contains collection.handle %}
	    {% assign found_a_collection = true %}
	  {% endunless %}
	{% endif %}
	{% unless found_a_collection %}
	  {% for c in product.collections %}
	    {% unless exclusions contains c.handle or c.all_products_count < 2 %}
	      {% assign found_a_collection = true %}
	      {% assign collection = c %}
	      {% break %}
	    {% endunless %}
	  {% endfor %}
	{% endunless %}

	{% if found_a_collection %}

	  {% assign counter = 0 %}
	  {% assign break_at = number_of_rows | times: number_of_related_products_per_row %}
	  {% assign current_product = product %}
	  
	  {% case number_of_related_products_per_row %}
	    {% when '1' %}
	      {% assign grid_item_width = 'l12 m12 s12' %}
	    {% when '2' %}
	      {% assign grid_item_width = 'l6 m6 s6' %}
	    {% when '3' %}
	      {% assign grid_item_width = 'l4 m6 s6' %}
	    {% when '4' %}
	      {% assign grid_item_width = 'l3 m6 s6' %}
	    {% when '5' %}
	      {% assign grid_item_width = 'l3 m6 s6' %}
	    {% when '6' %}
	      {% assign grid_item_width = 'l3 m6 s6' %}
	    {% else %}
	      {% assign grid_item_width = 'l4 m6 s6' %}
	  {% endcase %}

	{% endif %}

</div>

{% schema %}
	{
	  "name": "Related products",
	  "settings": [
	    {
	      "type": "checkbox",
	      "id": "show_related_products",
	      "label": "Show related products",
	      "default": true
	    },
	    {
	      "id": "related_title",
	      "type": "text",
	      "label": "Section title",
	      "default": "Related Products"
	    },
	    {
	      "type": "select",
	      "id": "related_grid_num",
	      "label": "Products per row (Desktop)",
	      "default": "4",
	      "options": [
	        {
	          "value": "2",
	          "label": "2"
	        },
	        {
	          "value": "3",
	          "label": "3"
	        },
	        {
	          "value": "4",
	          "label": "4"
	        },
	        {
	          "value": "5",
	          "label": "5"
	        }
	      ]
	    },
	    {
	      "type": "select",
	      "id": "related_grid_row",
	      "label": "Number of rows (Desktop)",
	      "default": "1",
	      "options": [
	        {
	          "value": "1",
	          "label": "1"
	        },
	        {
	          "value": "2",
	          "label": "2"
	        },
	        {
	          "value": "3",
	          "label": "3"
	        }
	      ]
	    }
	  ]
	}
{% endschema %}